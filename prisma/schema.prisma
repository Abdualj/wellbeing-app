// Prisma schema for Wellbeing App
// Supports: User-Centered Design, GDPR compliance, small-group privacy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with GDPR compliance fields
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  firstName         String
  lastName          String
  displayName       String?
  bio               String?
  avatar            String?
  
  // Privacy & GDPR
  consentGiven      Boolean   @default(false)
  consentDate       DateTime?
  dataProcessingConsent Boolean @default(false)
  marketingConsent  Boolean   @default(false)
  notificationPreference NotificationLevel @default(MINIMAL)
  
  // Account status
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  deletionRequested Boolean   @default(false)
  deletionRequestDate DateTime?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  memberships       Membership[]
  posts             Post[]
  comments          Comment[]
  eventParticipants EventParticipant[]
  auditLogs         AuditLog[]
  refreshTokens     RefreshToken[]
  
  @@index([email])
  @@index([isActive])
  @@map("users")
}

enum NotificationLevel {
  NONE
  MINIMAL
  NORMAL
  ALL
}

// Group model - small, closed, invitation-based
model Group {
  id                String    @id @default(uuid())
  name              String
  description       String?
  purpose           String?
  avatar            String?
  
  // Group settings
  maxMembers        Int       @default(12)
  isPrivate         Boolean   @default(true)
  requireApproval   Boolean   @default(true)
  
  // Status
  isActive          Boolean   @default(true)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  memberships       Membership[]
  posts             Post[]
  events            Event[]
  
  @@index([isActive])
  @@map("groups")
}

// Membership with roles
model Membership {
  id                String    @id @default(uuid())
  userId            String
  groupId           String
  role              MemberRole @default(MEMBER)
  
  // Status
  status            MembershipStatus @default(PENDING)
  invitedBy         String?
  
  // Timestamps
  joinedAt          DateTime  @default(now())
  leftAt            DateTime?
  
  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  group             Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("memberships")
}

enum MemberRole {
  MEMBER
  FACILITATOR
  ADMIN
}

enum MembershipStatus {
  PENDING
  ACTIVE
  INACTIVE
  LEFT
}

// Event / Activity
model Event {
  id                String    @id @default(uuid())
  groupId           String
  title             String
  description       String?
  location          String?
  locationDetails   String?
  
  // Timing
  startTime         DateTime
  endTime           DateTime?
  
  // Settings
  maxParticipants   Int?
  isOnline          Boolean   @default(false)
  meetingLink       String?
  
  // Status
  isCancelled       Boolean   @default(false)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  group             Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  participants      EventParticipant[]
  
  @@index([groupId])
  @@index([startTime])
  @@map("events")
}

// Event participation
model EventParticipant {
  id                String    @id @default(uuid())
  eventId           String
  userId            String
  status            ParticipationStatus @default(MAYBE)
  
  // Timestamps
  respondedAt       DateTime  @default(now())
  
  // Relations
  event             Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_participants")
}

enum ParticipationStatus {
  GOING
  MAYBE
  NOT_GOING
}

// Group posts - no public feed
model Post {
  id                String    @id @default(uuid())
  groupId           String
  authorId          String
  content           String
  attachments       String[]  @default([])
  
  // Moderation
  isDeleted         Boolean   @default(false)
  deletedAt         DateTime?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  group             Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  author            User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments          Comment[]
  
  @@index([groupId])
  @@index([authorId])
  @@index([createdAt])
  @@map("posts")
}

// Comments on posts
model Comment {
  id                String    @id @default(uuid())
  postId            String
  authorId          String
  content           String
  
  // Moderation
  isDeleted         Boolean   @default(false)
  deletedAt         DateTime?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  post              Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author            User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

// Refresh tokens for JWT
model RefreshToken {
  id                String    @id @default(uuid())
  userId            String
  token             String    @unique
  expiresAt         DateTime
  isRevoked         Boolean   @default(false)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  
  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Audit log for GDPR compliance and security
model AuditLog {
  id                String    @id @default(uuid())
  userId            String?
  action            String
  entity            String
  entityId          String?
  metadata          Json?
  ipAddress         String?
  userAgent         String?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  
  // Relations
  user              User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
